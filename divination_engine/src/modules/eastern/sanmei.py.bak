"""
ç®—å‘½å­¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
äººä½“æ˜Ÿå›³ï¼ˆåå¤§ä¸»æ˜Ÿãƒ»åäºŒå¤§å¾“æ˜Ÿï¼‰ã€å¤©ä¸­æ®ºã®è¨ˆç®—
"""
from datetime import datetime
from typing import Dict, List, Optional
from dataclasses import dataclass

from .sexagenary import SexagenaryCalculator
from ...core.calendar_cn import ChineseCalendar, FourPillars, Pillar
from ...models.output_schema import SanmeiResult, Pillar as PillarSchema


class SanmeiCalculator(SexagenaryCalculator):
    """
    ç®—å‘½å­¦è¨ˆç®—ã‚¯ãƒ©ã‚¹
    äººä½“æ˜Ÿå›³ï¼ˆé™½å ï¼‰ã®ä½œæˆã‚’è¡Œã†
    """
    
    # åå¤§ä¸»æ˜Ÿï¼ˆé€šå¤‰æ˜Ÿã®ç®—å‘½å­¦ç‰ˆï¼‰
    TEN_MAIN_STARS = {
        "æ¯”è‚©": "è²«ç´¢æ˜Ÿ",
        "åŠ«è²¡": "çŸ³é–€æ˜Ÿ",
        "é£Ÿç¥ž": "é³³é–£æ˜Ÿ",
        "å‚·å®˜": "èª¿èˆ’æ˜Ÿ",
        "åè²¡": "ç¦„å­˜æ˜Ÿ",
        "æ­£è²¡": "å¸ç¦„æ˜Ÿ",
        "åå®˜": "è»Šé¨Žæ˜Ÿ",
        "æ­£å®˜": "ç‰½ç‰›æ˜Ÿ",
        "åå°": "é¾é«˜æ˜Ÿ",
        "å°ç¶¬": "çŽ‰å ‚æ˜Ÿ",
    }
    
    # åäºŒå¤§å¾“æ˜Ÿï¼ˆåäºŒé‹ã®ç®—å‘½å­¦ç‰ˆï¼‰
    TWELVE_SUB_STARS = {
        "é•·ç”Ÿ": "å¤©å ±æ˜Ÿ",
        "æ²æµ´": "å¤©å°æ˜Ÿ",
        "å† å¸¯": "å¤©è²´æ˜Ÿ",
        "å»ºç¦„": "å¤©ææ˜Ÿ",
        "å¸æ—º": "å¤©å—æ˜Ÿ",
        "è¡°": "å¤©ç¦„æ˜Ÿ",
        "ç—…": "å¤©å°†æ˜Ÿ",
        "æ­»": "å¤©å ‚æ˜Ÿ",
        "å¢“": "å¤©èƒ¡æ˜Ÿ",
        "çµ¶": "å¤©æ¥µæ˜Ÿ",
        "èƒŽ": "å¤©åº«æ˜Ÿ",
        "é¤Š": "å¤©é¦³æ˜Ÿ",
    }
    
    # äººä½“æ˜Ÿå›³ã®ä½ç½®å
    BODY_POSITIONS = ["é ­", "èƒ¸", "è…¹", "å³æ‰‹", "å·¦æ‰‹", "å³è¶³", "å·¦è¶³"]
    
    # å¤©ä¸­æ®ºã®ã‚°ãƒ«ãƒ¼ãƒ—å
    VOID_GROUPS = {
        ("æˆŒ", "äº¥"): "æˆŒäº¥å¤©ä¸­æ®º",
        ("ç”³", "é…‰"): "ç”³é…‰å¤©ä¸­æ®º",
        ("åˆ", "æœª"): "åˆæœªå¤©ä¸­æ®º",
        ("è¾°", "å·³"): "è¾°å·³å¤©ä¸­æ®º",
        ("å¯…", "å¯"): "å¯…å¯å¤©ä¸­æ®º",
        ("å­", "ä¸‘"): "å­ä¸‘å¤©ä¸­æ®º",
    }
    
    # é€šå¤‰æ˜Ÿãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆå››æŸ±æŽ¨å‘½ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    TEN_GODS = {
        ("æœ¨", "æœ¨", True): "æ¯”è‚©", ("æœ¨", "æœ¨", False): "åŠ«è²¡",
        ("æœ¨", "ç«", True): "é£Ÿç¥ž", ("æœ¨", "ç«", False): "å‚·å®˜",
        ("æœ¨", "åœŸ", True): "åè²¡", ("æœ¨", "åœŸ", False): "æ­£è²¡",
        ("æœ¨", "é‡‘", True): "åå®˜", ("æœ¨", "é‡‘", False): "æ­£å®˜",
        ("æœ¨", "æ°´", True): "åå°", ("æœ¨", "æ°´", False): "å°ç¶¬",
        
        ("ç«", "ç«", True): "æ¯”è‚©", ("ç«", "ç«", False): "åŠ«è²¡",
        ("ç«", "åœŸ", True): "é£Ÿç¥ž", ("ç«", "åœŸ", False): "å‚·å®˜",
        ("ç«", "é‡‘", True): "åè²¡", ("ç«", "é‡‘", False): "æ­£è²¡",
        ("ç«", "æ°´", True): "åå®˜", ("ç«", "æ°´", False): "æ­£å®˜",
        ("ç«", "æœ¨", True): "åå°", ("ç«", "æœ¨", False): "å°ç¶¬",
        
        ("åœŸ", "åœŸ", True): "æ¯”è‚©", ("åœŸ", "åœŸ", False): "åŠ«è²¡",
        ("åœŸ", "é‡‘", True): "é£Ÿç¥ž", ("åœŸ", "é‡‘", False): "å‚·å®˜",
        ("åœŸ", "æ°´", True): "åè²¡", ("åœŸ", "æ°´", False): "æ­£è²¡",
        ("åœŸ", "æœ¨", True): "åå®˜", ("åœŸ", "æœ¨", False): "æ­£å®˜",
        ("åœŸ", "ç«", True): "åå°", ("åœŸ", "ç«", False): "å°ç¶¬",
        
        ("é‡‘", "é‡‘", True): "æ¯”è‚©", ("é‡‘", "é‡‘", False): "åŠ«è²¡",
        ("é‡‘", "æ°´", True): "é£Ÿç¥ž", ("é‡‘", "æ°´", False): "å‚·å®˜",
        ("é‡‘", "æœ¨", True): "åè²¡", ("é‡‘", "æœ¨", False): "æ­£è²¡",
        ("é‡‘", "ç«", True): "åå®˜", ("é‡‘", "ç«", False): "æ­£å®˜",
        ("é‡‘", "åœŸ", True): "åå°", ("é‡‘", "åœŸ", False): "å°ç¶¬",
        
        ("æ°´", "æ°´", True): "æ¯”è‚©", ("æ°´", "æ°´", False): "åŠ«è²¡",
        ("æ°´", "æœ¨", True): "é£Ÿç¥ž", ("æ°´", "æœ¨", False): "å‚·å®˜",
        ("æ°´", "ç«", True): "åè²¡", ("æ°´", "ç«", False): "æ­£è²¡",
        ("æ°´", "åœŸ", True): "åå®˜", ("æ°´", "åœŸ", False): "æ­£å®˜",
        ("æ°´", "é‡‘", True): "åå°", ("æ°´", "é‡‘", False): "å°ç¶¬",
    }
    
    # åäºŒé‹ãƒžãƒƒãƒ”ãƒ³ã‚°
    TWELVE_STAGES = {
        "ç”²": {"äº¥": "é•·ç”Ÿ", "å­": "æ²æµ´", "ä¸‘": "å† å¸¯", "å¯…": "å»ºç¦„", "å¯": "å¸æ—º", "è¾°": "è¡°", "å·³": "ç—…", "åˆ": "æ­»", "æœª": "å¢“", "ç”³": "çµ¶", "é…‰": "èƒŽ", "æˆŒ": "é¤Š"},
        "ä¹™": {"åˆ": "é•·ç”Ÿ", "å·³": "æ²æµ´", "è¾°": "å† å¸¯", "å¯": "å»ºç¦„", "å¯…": "å¸æ—º", "ä¸‘": "è¡°", "å­": "ç—…", "äº¥": "æ­»", "æˆŒ": "å¢“", "é…‰": "çµ¶", "ç”³": "èƒŽ", "æœª": "é¤Š"},
        "ä¸™": {"å¯…": "é•·ç”Ÿ", "å¯": "æ²æµ´", "è¾°": "å† å¸¯", "å·³": "å»ºç¦„", "åˆ": "å¸æ—º", "æœª": "è¡°", "ç”³": "ç—…", "é…‰": "æ­»", "æˆŒ": "å¢“", "äº¥": "çµ¶", "å­": "èƒŽ", "ä¸‘": "é¤Š"},
        "ä¸": {"é…‰": "é•·ç”Ÿ", "ç”³": "æ²æµ´", "æœª": "å† å¸¯", "åˆ": "å»ºç¦„", "å·³": "å¸æ—º", "è¾°": "è¡°", "å¯": "ç—…", "å¯…": "æ­»", "ä¸‘": "å¢“", "å­": "çµ¶", "äº¥": "èƒŽ", "æˆŒ": "é¤Š"},
        "æˆŠ": {"å¯…": "é•·ç”Ÿ", "å¯": "æ²æµ´", "è¾°": "å† å¸¯", "å·³": "å»ºç¦„", "åˆ": "å¸æ—º", "æœª": "è¡°", "ç”³": "ç—…", "é…‰": "æ­»", "æˆŒ": "å¢“", "äº¥": "çµ¶", "å­": "èƒŽ", "ä¸‘": "é¤Š"},
        "å·±": {"é…‰": "é•·ç”Ÿ", "ç”³": "æ²æµ´", "æœª": "å† å¸¯", "åˆ": "å»ºç¦„", "å·³": "å¸æ—º", "è¾°": "è¡°", "å¯": "ç—…", "å¯…": "æ­»", "ä¸‘": "å¢“", "å­": "çµ¶", "äº¥": "èƒŽ", "æˆŒ": "é¤Š"},
        "åºš": {"å·³": "é•·ç”Ÿ", "åˆ": "æ²æµ´", "æœª": "å† å¸¯", "ç”³": "å»ºç¦„", "é…‰": "å¸æ—º", "æˆŒ": "è¡°", "äº¥": "ç—…", "å­": "æ­»", "ä¸‘": "å¢“", "å¯…": "çµ¶", "å¯": "èƒŽ", "è¾°": "é¤Š"},
        "è¾›": {"å­": "é•·ç”Ÿ", "äº¥": "æ²æµ´", "æˆŒ": "å† å¸¯", "é…‰": "å»ºç¦„", "ç”³": "å¸æ—º", "æœª": "è¡°", "åˆ": "ç—…", "å·³": "æ­»", "è¾°": "å¢“", "å¯": "çµ¶", "å¯…": "èƒŽ", "ä¸‘": "é¤Š"},
        "å£¬": {"ç”³": "é•·ç”Ÿ", "é…‰": "æ²æµ´", "æˆŒ": "å† å¸¯", "äº¥": "å»ºç¦„", "å­": "å¸æ—º", "ä¸‘": "è¡°", "å¯…": "ç—…", "å¯": "æ­»", "è¾°": "å¢“", "å·³": "çµ¶", "åˆ": "èƒŽ", "æœª": "é¤Š"},
        "ç™¸": {"å¯": "é•·ç”Ÿ", "å¯…": "æ²æµ´", "ä¸‘": "å† å¸¯", "å­": "å»ºç¦„", "äº¥": "å¸æ—º", "æˆŒ": "è¡°", "é…‰": "ç—…", "ç”³": "æ­»", "æœª": "å¢“", "åˆ": "çµ¶", "å·³": "èƒŽ", "è¾°": "é¤Š"},
    }
    
    def __init__(self):
        super().__init__()
    
    def calculate(self, birth_dt: datetime) -> SanmeiResult:
        """
        ç®—å‘½å­¦ã‚’è¨ˆç®—
        
        Args:
            birth_dt: ç”Ÿå¹´æœˆæ—¥æ™‚ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä»˜ãï¼‰
            
        Returns:
            SanmeiResult
        """
        # å››æŸ±ã‚’è¨ˆç®—
        four_pillars = self.calendar.calc_four_pillars(birth_dt, use_early_rat=False)
        
        # å¤©ä¸­æ®º
        void_branches = list(self.calendar.calc_void_branches(four_pillars.day))
        void_group_name = self.get_void_group_name(tuple(void_branches))
        void_period = self._calc_void_period(void_branches)
        
        # åå¤§ä¸»æ˜Ÿã‚’è¨ˆç®—
        main_stars = self._calc_main_stars(four_pillars)
        
        # åäºŒå¤§å¾“æ˜Ÿã‚’è¨ˆç®—
        sub_stars = self._calc_sub_stars(four_pillars)
        
        # äººä½“æ˜Ÿå›³ã‚’ä½œæˆ
        body_chart = self._create_body_chart(main_stars, sub_stars)
        
        # æ•°ç†æ³•ï¼šã‚¨ãƒãƒ«ã‚®ãƒ¼æ•°å€¤ã‚’è¨ˆç®—
        energy_values = self._calc_energy_values(four_pillars)
        
        # ä½ç›¸æ³•ï¼šåˆæ³•ã¨æ•£æ³•ã‚’è¨ˆç®—
        phases = self._calc_phases(four_pillars)
        
        return SanmeiResult(
            four_pillars=self._convert_pillars_to_schema(four_pillars),
            void_branches=void_branches,
            void_group_name=void_group_name,
            void_period=void_period,
            main_stars=main_stars,
            sub_stars=sub_stars,
            body_chart=body_chart,
            energy_values=energy_values,
            phases=phases
        )
    
    def _convert_pillars_to_schema(self, fp: FourPillars):
        """FourPillarsã‚’å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒžã®å½¢å¼ã«å¤‰æ›"""
        from ...models.output_schema import FourPillars as FourPillarsSchema
        
        return FourPillarsSchema(
            year=PillarSchema(heavenly_stem=fp.year.stem, earthly_branch=fp.year.branch),
            month=PillarSchema(heavenly_stem=fp.month.stem, earthly_branch=fp.month.branch),
            day=PillarSchema(heavenly_stem=fp.day.stem, earthly_branch=fp.day.branch),
            hour=PillarSchema(heavenly_stem=fp.hour.stem, earthly_branch=fp.hour.branch)
        )
    
    def _calc_main_stars(self, fp: FourPillars) -> Dict[str, str]:
        """åå¤§ä¸»æ˜Ÿã‚’è¨ˆç®—"""
        result = {}
        day_master = fp.day.stem
        day_element = self.get_stem_element(day_master)
        day_yy = self.get_stem_yin_yang(day_master)
        
        # å¹´å¹²ã€æœˆå¹²ã€æ™‚å¹²ã¨ã®é–¢ä¿‚
        for pos_name, pillar in [("åŒ—ï¼ˆå¹´å¹²ï¼‰", fp.year), ("æ±ï¼ˆæœˆå¹²ï¼‰", fp.month), ("è¥¿ï¼ˆæ™‚å¹²ï¼‰", fp.hour)]:
            stem = pillar.stem
            stem_element = self.get_stem_element(stem)
            stem_yy = self.get_stem_yin_yang(stem)
            
            is_same_yy = (day_yy == stem_yy)
            key = (day_element, stem_element, is_same_yy)
            
            ten_god = self.TEN_GODS.get(key, "æ¯”è‚©")
            main_star = self.TEN_MAIN_STARS.get(ten_god, "è²«ç´¢æ˜Ÿ")
            result[pos_name] = main_star
        
        # ä¸­å¤®ï¼ˆæ—¥å¹²è‡ªèº«ï¼‰
        result["ä¸­å¤®ï¼ˆæ—¥å¹²ï¼‰"] = "è²«ç´¢æ˜Ÿ"  # è‡ªåˆ†è‡ªèº«
        
        # å—ï¼ˆåœ°æ”¯è”µå¹²ã®æœ¬æ°—ï¼‰
        day_branch = fp.day.branch
        hidden = self.get_hidden_stems(day_branch)
        if hidden:
            main_hidden = hidden[0]  # æœ¬æ°—
            main_hidden_element = self.get_stem_element(main_hidden)
            main_hidden_yy = self.get_stem_yin_yang(main_hidden)
            is_same_yy = (day_yy == main_hidden_yy)
            key = (day_element, main_hidden_element, is_same_yy)
            ten_god = self.TEN_GODS.get(key, "æ¯”è‚©")
            result["å—ï¼ˆæ—¥æ”¯ï¼‰"] = self.TEN_MAIN_STARS.get(ten_god, "è²«ç´¢æ˜Ÿ")
        else:
            result["å—ï¼ˆæ—¥æ”¯ï¼‰"] = "è²«ç´¢æ˜Ÿ"
        
        return result
    
    def _calc_sub_stars(self, fp: FourPillars) -> Dict[str, str]:
        """åäºŒå¤§å¾“æ˜Ÿã‚’è¨ˆç®—"""
        result = {}
        day_master = fp.day.stem
        stages_map = self.TWELVE_STAGES.get(day_master, {})
        
        for pos_name, pillar in [("å¹´æ”¯", fp.year), ("æœˆæ”¯", fp.month), ("æ—¥æ”¯", fp.day)]:
            branch = pillar.branch
            stage = stages_map.get(branch, "é•·ç”Ÿ")
            sub_star = self.TWELVE_SUB_STARS.get(stage, "å¤©å ±æ˜Ÿ")
            result[pos_name] = sub_star
        
        return result
    
    def _create_body_chart(self, main_stars: Dict[str, str], sub_stars: Dict[str, str]) -> Dict[str, str]:
        """äººä½“æ˜Ÿå›³ã‚’ä½œæˆ"""
        # ç°¡æ˜“ç‰ˆäººä½“æ˜Ÿå›³
        return {
            "é ­": main_stars.get("åŒ—ï¼ˆå¹´å¹²ï¼‰", ""),
            "å·¦è‚©": sub_stars.get("å¹´æ”¯", ""),
            "å³è‚©": sub_stars.get("æœˆæ”¯", ""),
            "èƒ¸": main_stars.get("æ±ï¼ˆæœˆå¹²ï¼‰", ""),
            "è…¹ï¼ˆä¸­å¿ƒï¼‰": main_stars.get("ä¸­å¤®ï¼ˆæ—¥å¹²ï¼‰", ""),
            "å³æ‰‹": main_stars.get("è¥¿ï¼ˆæ™‚å¹²ï¼‰", ""),
            "å·¦è¶³": main_stars.get("å—ï¼ˆæ—¥æ”¯ï¼‰", ""),
            "å³è¶³": sub_stars.get("æ—¥æ”¯", ""),
        }
    
    def get_void_group_name(self, void_branches: tuple) -> str:
        """å¤©ä¸­æ®ºã‚°ãƒ«ãƒ¼ãƒ—åã‚’å–å¾—"""
        return self.VOID_GROUPS.get(void_branches, "ä¸æ˜Ž")
         
         d e f   _ c a l c _ v o i d _ p e r i o d ( s e l f ,   v o i d _ b r a n c h e s :   L i s t [ s t r ] )   - >   D i c t [ s t r ,   s t r ] :  
                 " " "  
                 Ÿ‡iÿsƒmÿ?Œzÿ[‹ÄnãOg~š[hÿ²€nÿû0 
                  
                 A r g s :  
                         v o i d _ b r a n c h e s :   Ÿ‡iÿsƒmÿ?Œzÿ:~nÿh‡pÿ>‹oÿû0û0:~dÿû0û0 
                  
                 R e t u r n s :  
                         Ÿ‡iÿsƒmÿ?Œzÿ[‹ÄnãO:~nÿ—
jŒ] 
                 " " "  
                 #   Ÿ‡iÿsƒmÿ?Œzÿ:~nÿ[‹ÄnãO]~íiã0]~e¦g~pÿ 
                 v o i d _ p e r i o d s   =   {  
                         ( " ‹û0,   "  ƒeÿ" ) :   { " ÷‡tÿ" :   " ‹Ÿ`yÿtÿ]~{ÿ ƒeÿ÷‡tÿ" ,   " [‹û0:   " 1 0 [‹;Sû01 1 [‹û0,   " L‹eÿ" :   " ‹§h‹_]~{ÿ ƒeÿL‹eÿ" } ,  
                         ( " sÿ" ,   " _šû0) :   { " ÷‡tÿ" :   " sÿ÷‡tÿ]~{ÿ_šYryÿtÿ" ,   " [‹û0:   " 8 [‹;Sû09 [‹û0,   " L‹eÿ" :   " sÿL‹eÿ]~{ÿ_š;u‹_" } ,  
                         ( " 
‡û0,   " [‹jÿ" ) :   { " ÷‡tÿ" :   " 
‡¥Nyÿtÿ]~{ÿ[‹jÿ÷‡tÿ" ,   " [‹û0:   " 6 [‹;Sû07 [‹û0,   " L‹eÿ" :   " 
‡ßW‹_]~{ÿ[‹jÿL‹eÿ" } ,  
                         ( " —pÿ" ,   " þ‡sÿ" ) :   { " ÷‡tÿ" :   " —pÿ÷‡tÿ]~{ÿþ‡sÿ÷‡tÿ" ,   " [‹û0:   " 4 [‹;Sû05 [‹û0,   " L‹eÿ" :   " —pÿL‹eÿ]~{ÿþ‡sÿL‹eÿ" } ,  
                         ( " Ç‡û0,   " 
‡oÿ" ) :   { " ÷‡tÿ" :   " Ç‡û0yÿtÿ]~{ÿ
‡oÿ÷‡tÿ" ,   " [‹û0:   " 2 [‹;Sû03 [‹û0,   " L‹eÿ" :   " Ç‡û0‹_]~{ÿ
‡oÿL‹eÿ" } ,  
                         ( " Ä‡û0,   " sƒû0) :   { " ÷‡tÿ" :   " Ä‡ÙNyÿtÿ]~{ÿsƒ'Yyÿtÿ" ,   " [‹û0:   " 1 2 [‹;Sû01 [‹û0,   " L‹eÿ" :   " Ä‡HQ‹_]~{ÿsƒ,{‹_" } ,  
                 }  
                  
                 k e y   =   t u p l e ( v o i d _ b r a n c h e s )  
                 r e t u r n   v o i d _ p e r i o d s . g e t ( k e y ,   { " ÷‡tÿ" :   " sƒ´€û0" ,   " [‹û0:   " sƒ´€û0" ,   " L‹eÿ" :   " sƒ´€û0" } )  
          
         d e f   _ c a l c _ e n e r g y _ v a l u e s ( s e l f ,   f p :   F o u r P i l l a r s )   - >   D i c t [ s t r ,   i n t ] :  
                 " " "  
                 (‹pÿû0sÿS|ÿùXJ0]~*–g~nÿ]~|ÿ(‹pÿß†dÿg~š[hÿ²€nÿû0 
                  
                 LŒ`Ù\UŒS|ÿüXdÿiÿ÷‡rÿ]~{ÿh‡pÿ>‹oÿ:~nÿ(‹pÿß†dÿù†û0 
                 ‡kÿâš€ UŒS|ÿüXû0âš€ :~nÿg~hÿ]~*–g~nÿ]~|ÿ_šŠiû0 
                  
                 A r g s :  
                         f p :   W‡6^dm 
                  
                 R e t u r n s :  
                         g~hÿ]~*–g~nÿ]~|ÿ(‹pÿß†dÿ:~nÿ—
jŒ] 
                 " " "  
                 #   Ÿ‡iÿ÷‡rÿ:~nÿ(‹pÿß†dÿû0û0- 1 0 û0û0 
                 s t e m _ v a l u e s   =   {  
                         " rÿ" :   1 ,   " uƒû0:   2 ,   " sƒû0:   3 ,   " sƒû0:   4 ,   " ‹û0:   5 ,  
                         " þ‡qÿ" :   6 ,   " ˆû0:   7 ,   " —û0:   8 ,   " ¢‡lÿ" :   9 ,   " xÿ" :   1 0  
                 }  
                  
                 #   h‡pÿ>‹oÿ:~nÿ(‹pÿß†dÿû0û0- 1 2 û0û0 
                 b r a n c h _ v a l u e s   =   {  
                         " Ä‡û0:   1 ,   " sƒû0:   2 ,   " Ç‡û0:   3 ,   " 
‡oÿ" :   4 ,   " —pÿ" :   5 ,   " þ‡sÿ" :   6 ,  
                         " 
‡û0:   7 ,   " [‹jÿ" :   8 ,   " sÿ" :   9 ,   " _šû0:   1 0 ,   " ‹û0:   1 1 ,   "  ƒeÿ" :   1 2  
                 }  
                  
                 #   7‡û0dm:~nÿg~hÿ]~*–g~nÿ]~|ÿß†dÿ 
                 y e a r _ e n e r g y   =   s t e m _ v a l u e s . g e t ( f p . y e a r . s t e m ,   0 )   +   b r a n c h _ v a l u e s . g e t ( f p . y e a r . b r a n c h ,   0 )  
                 m o n t h _ e n e r g y   =   s t e m _ v a l u e s . g e t ( f p . m o n t h . s t e m ,   0 )   +   b r a n c h _ v a l u e s . g e t ( f p . m o n t h . b r a n c h ,   0 )  
                 d a y _ e n e r g y   =   s t e m _ v a l u e s . g e t ( f p . d a y . s t e m ,   0 )   +   b r a n c h _ v a l u e s . g e t ( f p . d a y . b r a n c h ,   0 )  
                 h o u r _ e n e r g y   =   s t e m _ v a l u e s . g e t ( f p . h o u r . s t e m ,   0 )   +   b r a n c h _ v a l u e s . g e t ( f p . h o u r . b r a n c h ,   0 )  
                  
                 #   7‡Áhÿ;SJ0]~*–g~nÿ]~|ÿ 
                 t o t a l _ e n e r g y   =   y e a r _ e n e r g y   +   m o n t h _ e n e r g y   +   d a y _ e n e r g y   +   h o u r _ e n e r g y  
                  
                 #   LŒ`Ù\UŒû0ß†dÿ 
                 k i _ v a l u e   =   t o t a l _ e n e r g y   %   9  
                 i f   k i _ v a l u e   = =   0 :  
                         k i _ v a l u e   =   9  
                  
                 r e t u r n   {  
                         " ÷‡tÿ_‹qÿ" :   y e a r _ e n e r g y ,  
                         " [‹ßWdm" :   m o n t h _ e n e r g y ,  
                         " L‹eÿ_‹qÿ" :   d a y _ e n e r g y ,  
                         " N‹ˆ0dm" :   h o u r _ e n e r g y ,  
                         " 7‡Áhÿû0:   t o t a l _ e n e r g y ,  
                         " LŒ`Ù\ß†dÿ" :   k i _ v a l u e ,  
                 }  
          
         d e f   _ c a l c _ p h a s e s ( s e l f ,   f p :   F o u r P i l l a r s )   - >   D i c t [ s t r ,   L i s t [ s t r ] ] :  
                 " " "  
                 ôƒ²TŒ]UŒS|ÿüX‹|UŒ’!(‹cÿUŒRÿª–²€nÿû0 
                  
                 7‡ßWsÿS|ÿýXêš7‡;S€ ="xÿYr‹|2~5"Z7‡û0 
                 (‹cÿUŒS|ÿüXoÿ~ÿ ‡rÿ2~"û02~"nÿsÿ 
                  
                 A r g s :  
                         f p :   W‡6^dm 
                  
                 R e t u r n s :  
                         ôƒ²TŒ]:~nÿ—
jŒ] 
                 " " "  
                 7‡ßWsÿû0=   [ ]  
                 (‹cÿUŒû0=   [ ]  
                  
                 b r a n c h e s   =   [  
                         ( " ÷‡tÿ>‹oÿ" ,   f p . y e a r . b r a n c h ) ,  
                         ( " [‹ßWêš" ,   f p . m o n t h . b r a n c h ) ,  
                         ( " L‹eÿ>‹oÿ" ,   f p . d a y . b r a n c h ) ,  
                         ( " N‹ˆ0êš" ,   f p . h o u r . b r a n c h )  
                 ]  
                  
                 #   >‹oÿ7‡(ƒ|ÿ¥Nû07‡(ƒ|ÿû0 
                 ‡mÿ7‡û0=   {  
                         ( " Ä‡û0,   " sƒû0) :   " h‡û0,   ( " Ç‡û0,   "  ƒeÿ" ) :   " [‹hÿ" ,   ( " 
‡oÿ" ,   " ‹û0) :   " ckÿ" ,  
                         ( " —pÿ" ,   " _šû0) :   " ešû0,   ( " þ‡sÿ" ,   " sÿ" ) :   " LŒtÿ" ,   ( " 
‡û0,   " [‹jÿ" ) :   " ckÿ"  
                 }  
                  
                 #   sƒYr‹| 
                 sƒYr‹|  =   {  
                         ( " sÿ" ,   " Ä‡û0,   " —pÿ" ) :   " LŒtÿ»‡€ " ,   ( "  ƒeÿ" ,   " 
‡oÿ" ,   " [‹jÿ" ) :   " [‹hÿ»‡€ " ,  
                         ( " Ç‡û0,   " 
‡û0,   " ‹û0) :   " ckÿ»‡€ " ,   ( " þ‡sÿ" ,   " _šû0,   " sƒû0) :   " eš'Yqÿ€ "  
                 }  
                  
                 #   Ç‡~ÿ ‡rÿû0¥Nû0 ‡rÿû0û0 
                 ‡mÿ ‡rÿ  =   {  
                         " Ä‡û0:   " 
‡û0,   " sƒû0:   " [‹jÿ" ,   " Ç‡û0:   " sÿ" ,   " 
‡oÿ" :   " _šû0,  
                         " —pÿ" :   " ‹û0,   " þ‡sÿ" :   "  ƒeÿ" ,   " 
‡û0:   " Ä‡û0,   " [‹jÿ" :   " sƒû0,  
                         " sÿ" :   " Ç‡û0,   " _šû0:   " 
‡oÿ" ,   " ‹û0:   " —pÿ" ,   "  ƒeÿ" :   " þ‡sÿ"  
                 }  
                  
                 #   >‹oÿ7‡;SRÿ]~"I0]~û0Q0 
                 f o r   i   i n   r a n g e ( l e n ( b r a n c h e s ) ) :  
                         f o r   j   i n   r a n g e ( i   +   1 ,   l e n ( b r a n c h e s ) ) :  
                                 n a m e 1 ,   b r a n c h 1   =   b r a n c h e s [ i ]  
                                 n a m e 2 ,   b r a n c h 2   =   b r a n c h e s [ j ]  
                                  
                                 #   ‡mÿ7‡û0 
                                 p a i r   =   t u p l e ( s o r t e d ( [ b r a n c h 1 ,   b r a n c h 2 ] ) )  
                                 i f   p a i r   i n   ‡mÿ7‡û0 
                                         7‡ßWsÿû0a p p e n d ( f " { n a m e 1 } ]~{ÿ{ n a m e 2 } û0üXû07‡(ƒ|ÿû0‡mÿ7‡û0p a i r ] } ù†„S|ÿû0)  
                                  
                                 #   Ç‡~ÿ ‡rÿ 
                                 i f   ‡mÿ ‡rÿ. g e t ( b r a n c h 1 )   = =   b r a n c h 2 :  
                                         (‹cÿUŒû0a p p e n d ( f " { n a m e 1 } ]~{ÿ{ n a m e 2 } û0üXoÿ~ÿ ‡rÿ" )  
                  
                 #   sƒYr‹|g~uPá0g~gÿ]~û0Q0û0²€pÿaÿO‹K“¿lû0û0 
                 a l l _ b r a n c h e s   =   [ b   f o r   _ ,   b   i n   b r a n c h e s ]  
                 f o r   c o m b o ,   n a t u r e   i n   sƒYr‹|. i t e m s ( ) :  
                         i f   a l l ( b   i n   a l l _ b r a n c h e s   f o r   b   i n   c o m b o ) :  
                                 7‡ßWsÿû0a p p e n d ( f " sƒYr‹|û04Vn a t u r e } " )  
                  
                 r e t u r n   {  
                         " 7‡ßWsÿû0:   7‡ßWsÿû0i f   7‡ßWsÿû0e l s e   [ " :~jÿ:~û0] ,  
                         " (‹cÿUŒû0:   (‹cÿUŒû0i f   (‹cÿUŒû0e l s e   [ " :~jÿ:~û0]  
                 }  
 