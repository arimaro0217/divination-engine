"""
紫微斗数 定数定義モジュール
Zi Wei Dou Shu Constants Module

100以上の諸星、十二宮、五行局、四化表、輝度テーブルを完全定義
"""

from typing import Dict, List, Tuple
from dataclasses import dataclass
from enum import Enum, IntEnum


# ============================================
# 基本定数
# ============================================

# 十二支（地支）
BRANCHES = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]
BRANCH_INDICES = {b: i for i, b in enumerate(BRANCHES)}

# 十干（天干）
STEMS = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
STEM_INDICES = {s: i for i, s in enumerate(STEMS)}

# 十干の陰陽
STEM_YIN_YANG = {
    "甲": "陽", "乙": "陰", "丙": "陽", "丁": "陰", "戊": "陽",
    "己": "陰", "庚": "陽", "辛": "陰", "壬": "陽", "癸": "陰"
}


# ============================================
# 十二宮の定義
# ============================================

class PalaceType(Enum):
    """十二宮の種類"""
    LIFE = "命宮"           # Life Palace
    SIBLINGS = "兄弟宮"     # Siblings Palace
    SPOUSE = "夫妻宮"       # Spouse Palace
    CHILDREN = "子女宮"     # Children Palace
    WEALTH = "財帛宮"       # Wealth Palace
    HEALTH = "疾厄宮"       # Health Palace
    TRAVEL = "遷移宮"       # Travel Palace
    SERVANTS = "奴僕宮"     # Servants/Friends Palace
    CAREER = "官禄宮"       # Career Palace
    PROPERTY = "田宅宮"     # Property Palace
    FORTUNE = "福徳宮"      # Fortune/Virtue Palace
    PARENTS = "父母宮"      # Parents Palace


# 宮の配置順序（命宮から反時計回り）
PALACE_ORDER = [
    PalaceType.LIFE, PalaceType.PARENTS, PalaceType.FORTUNE, PalaceType.PROPERTY,
    PalaceType.CAREER, PalaceType.SERVANTS, PalaceType.TRAVEL, PalaceType.HEALTH,
    PalaceType.WEALTH, PalaceType.CHILDREN, PalaceType.SPOUSE, PalaceType.SIBLINGS
]

# 宮名リスト
PALACES = [
    "命宮", "兄弟宮", "夫妻宮", "子女宮", "財帛宮", "疾厄宮",
    "遷移宮", "奴僕宮", "官禄宮", "田宅宮", "福徳宮", "父母宮"
]


# ============================================
# 星のカテゴリと定義
# ============================================

class StarCategory(Enum):
    """星のカテゴリ"""
    MAJOR_ZIWEI = "紫微星系"
    MAJOR_TIANFU = "天府星系"
    AUXILIARY_A = "甲級副星"
    AUXILIARY_B = "乙級副星"
    AUXILIARY_C = "丙級副星"
    AUXILIARY_D = "丁級副星"


class Brightness(IntEnum):
    """星の輝度（6段階）"""
    MIAO = 6      # 廟（最強）
    WANG = 5      # 旺
    DE = 4        # 得
    PING = 3      # 平
    BU = 2        # 不
    XIAN = 1      # 陥（最弱）


BRIGHTNESS_NAMES = {
    Brightness.MIAO: "廟",
    Brightness.WANG: "旺",
    Brightness.DE: "得",
    Brightness.PING: "平",
    Brightness.BU: "不",
    Brightness.XIAN: "陥",
}


# ============================================
# 十四主星（甲級主星）
# ============================================

MAIN_STARS = [
    "紫微", "天機", "太陽", "武曲", "天同", "廉貞", "天府",
    "太陰", "貪狼", "巨門", "天相", "天梁", "七殺", "破軍"
]

# 紫微星群の配置オフセット
ZIWEI_GROUP_OFFSETS = {
    "紫微": 0,
    "天機": -1,
    "太陽": -3,
    "武曲": -4,
    "天同": -5,
    "廉貞": -8
}

# 天府星群の配置オフセット
TIANFU_GROUP_OFFSETS = {
    "天府": 0,
    "太陰": 1,
    "貪狼": 2,
    "巨門": 3,
    "天相": 4,
    "天梁": 5,
    "七殺": 6,
    "破軍": 10
}


# ============================================
# 各主星の輝度テーブル（12宮別）
# ============================================

# 輝度マッピング: 子丑寅卯辰巳午未申酉戌亥
STAR_BRIGHTNESS = {
    "紫微": [5, 3, 6, 6, 3, 5, 6, 3, 5, 3, 6, 3],
    "天機": [6, 3, 3, 6, 4, 3, 1, 3, 3, 6, 4, 3],
    "太陽": [1, 3, 5, 6, 6, 6, 6, 5, 3, 3, 1, 1],
    "武曲": [5, 3, 3, 6, 6, 3, 3, 3, 3, 5, 5, 3],
    "天同": [4, 3, 3, 3, 1, 6, 3, 3, 3, 3, 1, 3],
    "廉貞": [3, 3, 6, 3, 3, 3, 3, 6, 6, 3, 3, 3],
    "天府": [6, 5, 4, 3, 3, 3, 6, 5, 4, 3, 6, 5],
    "太陰": [6, 6, 5, 3, 1, 1, 1, 3, 5, 6, 6, 6],
    "貪狼": [5, 3, 6, 3, 3, 3, 5, 4, 6, 3, 3, 3],
    "巨門": [5, 3, 6, 3, 3, 3, 5, 3, 6, 3, 3, 3],
    "天相": [6, 3, 3, 1, 3, 6, 6, 3, 3, 1, 3, 6],
    "天梁": [6, 3, 3, 3, 3, 6, 6, 3, 3, 3, 3, 6],
    "七殺": [5, 3, 6, 3, 3, 5, 5, 3, 6, 3, 3, 5],
    "破軍": [5, 3, 3, 1, 3, 5, 5, 3, 3, 1, 3, 5],
}


# ============================================
# 副星・雑星（乙級〜丁級）
# ============================================

# 甲級副星
AUXILIARY_A_STARS = [
    "文昌", "文曲", "左輔", "右弼", "天魁", "天鉞", "禄存",
    "擎羊", "陀羅", "火星", "鈴星", "地空", "地劫"
]

# 乙級副星
AUXILIARY_B_STARS = [
    "天刑", "天姚", "天喜", "紅鸞", "天馬", "解神", "天巫", "天月", "陰煞"
]

# 丙級副星
AUXILIARY_C_STARS = [
    "台輔", "封誥", "天官", "天福", "天廚", "龍池", "鳳閣", 
    "三台", "八座", "恩光", "天貴"
]

# 丁級副星
AUXILIARY_D_STARS = [
    "天傷", "天使", "天空", "截空", "旬空", "孤辰", "寡宿",
    "破碎", "華蓋", "咸池", "天哭", "天虛"
]


# ============================================
# 四化星（生年天干別）
# ============================================

FOUR_TRANSFORMATIONS = {
    "甲": {"化禄": "廉貞", "化権": "破軍", "化科": "武曲", "化忌": "太陽"},
    "乙": {"化禄": "天機", "化権": "天梁", "化科": "紫微", "化忌": "太陰"},
    "丙": {"化禄": "天同", "化権": "天機", "化科": "文昌", "化忌": "廉貞"},
    "丁": {"化禄": "太陰", "化権": "天同", "化科": "天機", "化忌": "巨門"},
    "戊": {"化禄": "貪狼", "化権": "太陰", "化科": "右弼", "化忌": "天機"},
    "己": {"化禄": "武曲", "化権": "貪狼", "化科": "天梁", "化忌": "文曲"},
    "庚": {"化禄": "太陽", "化権": "武曲", "化科": "太陰", "化忌": "天同"},
    "辛": {"化禄": "巨門", "化権": "太陽", "化科": "文曲", "化忌": "文昌"},
    "壬": {"化禄": "天梁", "化権": "紫微", "化科": "左輔", "化忌": "武曲"},
    "癸": {"化禄": "破軍", "化権": "巨門", "化科": "太陰", "化忌": "貪狼"},
}

SIHUA_TABLE = FOUR_TRANSFORMATIONS  # エイリアス


# ============================================
# 五行局
# ============================================

class Bureau(IntEnum):
    """五行局"""
    WATER = 2  # 水二局
    WOOD = 3   # 木三局
    GOLD = 4   # 金四局
    EARTH = 5  # 土五局
    FIRE = 6   # 火六局


JU_NAMES = {
    2: "水二局",
    3: "木三局",
    4: "金四局",
    5: "土五局",
    6: "火六局"
}

BUREAU_NAMES = JU_NAMES  # エイリアス

# 五行局判定テーブル
JU_TABLE = [
    [4, 6, 5, 2, 3],  # 子丑グループ
    [3, 4, 6, 5, 2],  # 寅卯グループ
    [2, 3, 4, 6, 5],  # 辰巳グループ
    [5, 2, 3, 4, 6],  # 午未グループ
    [6, 5, 2, 3, 4],  # 申酉グループ
    [4, 6, 5, 2, 3],  # 戌亥グループ
]


# ============================================
# 紫微星の位置早見表
# ============================================

ZIWEI_POSITION_TABLE = {
    2: [1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 0, 0, 1, 1, 2, 2, 3, 3, 4],
    3: [2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10, 11, 11, 11, 0],
    4: [2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10],
    5: [3, 3, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 9, 9, 9],
    6: [3, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 9],
}


# ============================================
# 命宮・身宮の決定テーブル
# ============================================

LIFE_PALACE_TABLE = [
    [2,  1,  0,  11, 10, 9,  8,  7,  6,  5,  4,  3],
    [3,  2,  1,  0,  11, 10, 9,  8,  7,  6,  5,  4],
    [4,  3,  2,  1,  0,  11, 10, 9,  8,  7,  6,  5],
    [5,  4,  3,  2,  1,  0,  11, 10, 9,  8,  7,  6],
    [6,  5,  4,  3,  2,  1,  0,  11, 10, 9,  8,  7],
    [7,  6,  5,  4,  3,  2,  1,  0,  11, 10, 9,  8],
    [8,  7,  6,  5,  4,  3,  2,  1,  0,  11, 10, 9],
    [9,  8,  7,  6,  5,  4,  3,  2,  1,  0,  11, 10],
    [10, 9,  8,  7,  6,  5,  4,  3,  2,  1,  0,  11],
    [11, 10, 9,  8,  7,  6,  5,  4,  3,  2,  1,  0],
    [0,  11, 10, 9,  8,  7,  6,  5,  4,  3,  2,  1],
    [1,  0,  11, 10, 9,  8,  7,  6,  5,  4,  3,  2],
]

BODY_PALACE_TABLE = [
    [2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 0,  1],
    [3,  4,  5,  6,  7,  8,  9,  10, 11, 0,  1,  2],
    [4,  5,  6,  7,  8,  9,  10, 11, 0,  1,  2,  3],
    [5,  6,  7,  8,  9,  10, 11, 0,  1,  2,  3,  4],
    [6,  7,  8,  9,  10, 11, 0,  1,  2,  3,  4,  5],
    [7,  8,  9,  10, 11, 0,  1,  2,  3,  4,  5,  6],
    [8,  9,  10, 11, 0,  1,  2,  3,  4,  5,  6,  7],
    [9,  10, 11, 0,  1,  2,  3,  4,  5,  6,  7,  8],
    [10, 11, 0,  1,  2,  3,  4,  5,  6,  7,  8,  9],
    [11, 0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  10],
    [0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  10, 11],
    [1,  2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 0],
]


# ============================================
# 副星の配置テーブル
# ============================================

# 禄存の位置（年干別）
LUCUN_TABLE = {
    "甲": 2, "乙": 3, "丙": 5, "丁": 6, "戊": 5,
    "己": 6, "庚": 8, "辛": 9, "壬": 11, "癸": 0,
}

# 天魁の位置（年干別）
TIANKUI_TABLE = {
    "甲": 1, "乙": 0, "丙": 11, "丁": 9, "戊": 1,
    "己": 0, "庚": 1, "辛": 6, "壬": 3, "癸": 3,
}

# 天鉞の位置（年干別）
TIANYUE_TABLE = {
    "甲": 7, "乙": 8, "丙": 9, "丁": 11, "戊": 7,
    "己": 8, "庚": 7, "辛": 2, "壬": 5, "癸": 5,
}

# 文昌・文曲の基準
WENCHANG_BASE = 10  # 戌
WENQU_BASE = 4      # 辰

# 左輔・右弼の基準
ZUOFU_BASE = 4      # 辰
YOUBI_BASE = 10     # 戌

# 火星・鈴星の配置（年支グループ別）
HUOXING_TABLE = {
    "寅午戌": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 0],
    "申子辰": [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 0, 1],
    "巳酉丑": [3, 4, 5, 6, 7, 8, 9, 10, 11, 0, 1, 2],
    "亥卯未": [9, 10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8],
}

LINGXING_TABLE = {
    "寅午戌": [10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
    "申子辰": [10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
    "巳酉丑": [10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
    "亥卯未": [10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
}

def get_year_branch_group(year_branch_idx: int) -> str:
    """年支から火星・鈴星のグループを取得"""
    if year_branch_idx in [2, 6, 10]:
        return "寅午戌"
    elif year_branch_idx in [8, 0, 4]:
        return "申子辰"
    elif year_branch_idx in [5, 9, 1]:
        return "巳酉丑"
    else:
        return "亥卯未"


# ============================================
# 十二長生（十二運）
# ============================================

TWELVE_PHASES = [
    "長生", "沐浴", "冠帯", "臨官", "帝旺", "衰",
    "病", "死", "墓", "絶", "胎", "養"
]


# ============================================
# Webフロント用グリッド座標
# ============================================

PALACE_GRID_COORDS = {
    "辰": (0, 0), "巳": (0, 1), "午": (0, 2), "未": (0, 3),
    "卯": (1, 0),                             "申": (1, 3),
    "寅": (2, 0),                             "酉": (2, 3),
    "丑": (3, 0), "子": (3, 1), "亥": (3, 2), "戌": (3, 3),
}
